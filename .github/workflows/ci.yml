name: Docker Image CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY_NAME: dsmsacr
  CLUSTER_NAME: ds-ms
  CLUSTER_RESOURCE_GROUP: ds-ms
  NAMESPACE: demo-e2e

jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Building the Docker image
      run: |
        docker build . --tag demo-e2e
    
    - uses: ds-ms/container-scan@releases/v0
      name: Container Scan
      id: imagescan
      continue-on-error: true
      with:
        image-name: demo-e2e
    
    - name: Docker login
      uses: azure/docker-login@v1
      with:
        login-server: dsmsacr.azurecr.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push image
      run: |
        docker tag demo-e2e ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}

    - name: Upload Container Scan Report
      uses: github/codeql-action/upload-sarif@v1
      if: github.event.ref == 'refs/heads/master'
      with:
        sarif_file: ${{ steps.imagescan.outputs.sarif-file-path }}
  
  deploy:
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    steps:
    - uses: actions/checkout@v2

    - name: Login to Azure
      uses: azure/login@v1.1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
        enable-AzPSSession: true
    
    - name: Deploy to containerized web app
      uses: azure/webapps-deploy@v1
      with:
        app-name: 'e2egoapp'
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}

  post-deploy:
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
    - uses: ds-ms/asc-assessment@master
      name: "Create Assessment"
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          resource-group: ${{ env.CLUSTER_RESOURCE_GROUP }}
          cluster-name:  ${{ env.CLUSTER_NAME }}
          severity: Medium

    - name: Login to Azure
      uses: azure/login@v1.1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
        enable-AzPSSession: true

    - name: Check resource policy compliance post deployment
      uses: ajinkya599/AzPac@azpac-initial
      with:
        scopes: |
          ${{secrets.POLICY_SCAN_SCOPE}}

